<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üèÉ MUOVITI - Whoop Nagger</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Space+Grotesk:wght@400;700&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --bg: #0a0a0a;
      --card: #141414;
      --border: #2a2a2a;
      --text: #e0e0e0;
      --muted: #666;
      --success: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
      --accent: #3b82f6;
      --recovery-green: #22c55e;
      --recovery-yellow: #f59e0b;
      --recovery-red: #ef4444;
    }
    
    body {
      font-family: 'Space Grotesk', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    h1 {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 800;
      font-size: 1.5rem;
      letter-spacing: -1px;
    }
    
    .status-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--card);
      border-radius: 20px;
      font-size: 0.85rem;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }
    
    .status-dot.disconnected {
      background: var(--danger);
    }
    
    /* Hero Status */
    .hero {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
    }
    
    .hero.success {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, var(--card) 100%);
    }
    
    .hero.danger {
      border-color: var(--danger);
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, var(--card) 100%);
      animation: pulse-danger 2s ease-in-out infinite;
    }
    
    @keyframes pulse-danger {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
    }
    
    .hero-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }
    
    .hero-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 10px;
    }
    
    .hero.danger .hero-title {
      color: var(--danger);
    }
    
    .hero.success .hero-title {
      color: var(--success);
    }
    
    .hero-subtitle {
      color: var(--muted);
      font-size: 1.1rem;
    }
    
    /* Whoop Data Section */
    .whoop-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 30px;
    }
    
    .whoop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .whoop-metric {
      text-align: center;
      padding: 20px 15px;
      background: var(--bg);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    
    .whoop-metric-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 2.2rem;
      font-weight: 800;
      line-height: 1;
    }
    
    .whoop-metric-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin-top: 8px;
    }
    
    .whoop-metric-detail {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 4px;
    }
    
    .recovery-green { color: var(--recovery-green); }
    .recovery-yellow { color: var(--recovery-yellow); }
    .recovery-red { color: var(--recovery-red); }
    
    /* Daily Checklist */
    .checklist-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 30px;
    }
    
    .checklist-item {
      display: flex;
      align-items: center;
      padding: 16px;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    
    .checklist-item:last-child {
      margin-bottom: 0;
    }
    
    .checklist-item:hover {
      border-color: var(--border);
    }
    
    .checklist-item.completed {
      border-color: var(--success);
      background: rgba(34, 197, 94, 0.1);
    }
    
    .checklist-item.failed {
      border-color: var(--danger);
      background: rgba(239, 68, 68, 0.1);
    }
    
    .checklist-checkbox {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 16px;
      font-size: 1rem;
      flex-shrink: 0;
    }
    
    .checklist-item.completed .checklist-checkbox {
      background: var(--success);
      border-color: var(--success);
    }
    
    .checklist-item.failed .checklist-checkbox {
      background: var(--danger);
      border-color: var(--danger);
    }
    
    .checklist-content {
      flex: 1;
    }
    
    .checklist-title {
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .checklist-desc {
      font-size: 0.85rem;
      color: var(--muted);
    }
    
    .checklist-item.completed .checklist-title {
      text-decoration: line-through;
      color: var(--muted);
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
    }
    
    .stat-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 2rem;
      font-weight: 700;
    }
    
    .stat-value.success { color: var(--success); }
    .stat-value.danger { color: var(--danger); }
    .stat-value.warning { color: var(--warning); }
    
    .stat-detail {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 4px;
    }
    
    /* Weight Section */
    .weight-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 30px;
    }
    
    .section-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1rem;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .progress-bar {
      height: 24px;
      background: var(--border);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      margin-bottom: 15px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), var(--accent));
      border-radius: 12px;
      transition: width 0.5s ease;
    }
    
    .progress-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: var(--muted);
    }
    
    .weight-input-row {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    input[type="number"] {
      flex: 1;
      padding: 12px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 1rem;
    }
    
    input[type="number"]:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    button {
      padding: 12px 24px;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: white;
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.1s, opacity 0.2s;
    }
    
    button:hover {
      opacity: 0.9;
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    button.secondary {
      background: var(--border);
    }
    
    button.danger {
      background: var(--danger);
    }
    
    /* Activity Log */
    .activity-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 30px;
    }
    
    .day-row {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .day-row:last-child {
      border-bottom: none;
    }
    
    .day-date {
      width: 100px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      color: var(--muted);
    }
    
    .day-status {
      width: 30px;
      text-align: center;
    }
    
    .day-details {
      flex: 1;
      font-size: 0.9rem;
      color: var(--muted);
    }
    
    /* Whoop Connection */
    .connect-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      margin-bottom: 30px;
    }
    
    .connect-section a {
      display: inline-block;
      padding: 12px 24px;
      background: #ff6b00;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 700;
      margin-top: 15px;
    }
    
    /* Action buttons row */
    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    
    /* Footer */
    footer {
      text-align: center;
      padding: 20px;
      color: var(--muted);
      font-size: 0.85rem;
    }
    
    /* Responsive */
    @media (max-width: 600px) {
      .hero {
        padding: 30px 20px;
      }
      
      .hero-title {
        font-size: 1.5rem;
      }
      
      .stat-value {
        font-size: 1.5rem;
      }
      
      header {
        flex-direction: column;
        gap: 15px;
      }
      
      .whoop-metric-value {
        font-size: 1.8rem;
      }
      
      .whoop-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      color: var(--muted);
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Time display */
    .current-time {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üèÉ WHOOP NAGGER</h1>
      <div style="display: flex; align-items: center; gap: 15px;">
        <span class="current-time" id="current-time"></span>
        <div class="status-badge" id="whoop-status">
          <span class="status-dot disconnected"></span>
          <span>Caricamento...</span>
        </div>
      </div>
    </header>
    
    <main id="app">
      <div class="loading">
        <div class="spinner"></div>
      </div>
    </main>
    
    <footer>
      Obiettivo Pasqua: 85 kg ‚Ä¢ Un giorno alla volta üí™
    </footer>
  </div>
  
  <script>
    const API_BASE = '/api';
    let dashboardData = null;
    
    // Update time
    function updateTime() {
      const now = new Date();
      document.getElementById('current-time').textContent = now.toLocaleString('it-IT', {
        weekday: 'short',
        day: 'numeric',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    setInterval(updateTime, 1000);
    updateTime();
    
    // Fetch dashboard data
    async function fetchDashboard() {
      try {
        const res = await fetch(`${API_BASE}/dashboard`);
        const data = await res.json();
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        dashboardData = data;
        render();
      } catch (error) {
        console.error('Error fetching dashboard:', error);
        document.getElementById('app').innerHTML = `
          <div class="hero danger">
            <div class="hero-icon">‚ùå</div>
            <div class="hero-title">ERRORE</div>
            <div class="hero-subtitle">${error.message}</div>
            <p style="margin-top: 20px; color: var(--muted);">
              Controlla che:<br>
              - Il database Supabase sia configurato<br>
              - L'utente esista nella tabella users<br>
              - Le variabili .env siano corrette
            </p>
          </div>
        `;
      }
    }
    
    // Get recovery color class
    function getRecoveryColor(score) {
      if (score >= 67) return 'recovery-green';
      if (score >= 34) return 'recovery-yellow';
      return 'recovery-red';
    }
    
    // Render dashboard
    function render() {
      const data = dashboardData;
      const today = data.today;
      const stats = data.stats;
      const weight = data.weight;
      
      // Update Whoop status
      const statusEl = document.getElementById('whoop-status');
      if (data.user.whoop_connected) {
        statusEl.innerHTML = `
          <span class="status-dot"></span>
          <span>Whoop connesso</span>
        `;
      } else {
        statusEl.innerHTML = `
          <span class="status-dot disconnected"></span>
          <span>Whoop non connesso</span>
        `;
      }
      
      // Calculate progress
      const totalToLose = 93 - 85; // 8 kg
      const lost = 93 - weight.current;
      const progressPercent = Math.min(100, Math.max(0, (lost / totalToLose) * 100));
      
      // Format activity history
      const activityRows = data.activity_history.slice(0, 7).map(day => {
        const date = new Date(day.date);
        const dateStr = date.toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric' });
        const icon = day.workout_done ? '‚úÖ' : '‚ùå';
        let detail = '';
        if (day.workout_type) detail += day.workout_type;
        if (day.workout_strain) detail += ` ‚Ä¢ Strain: ${day.workout_strain.toFixed(1)}`;
        if (day.alcohol) detail += ' ‚Ä¢ üç∫';
        
        return `
          <div class="day-row">
            <div class="day-date">${dateStr}</div>
            <div class="day-status">${icon}</div>
            <div class="day-details">${detail || '-'}</div>
          </div>
        `;
      }).join('');
      
      // Build checklist status
      const checklistItems = [
        {
          id: 'workout',
          title: 'üèãÔ∏è Attivit√† Fisica',
          desc: 'Bici ufficio, cyclette, padel o pesi',
          completed: today.workout_done,
          type: 'positive'
        },
        {
          id: 'meals',
          title: 'ü•ó Pasti OK',
          desc: 'Proteine + verdure, no lasagne/cannelloni',
          completed: today.meals_ok,
          type: 'positive'
        },
        {
          id: 'alcohol',
          title: 'üç∫ No Alcol',
          desc: 'Max 1 serata a settimana (gioved√¨ o venerd√¨)',
          completed: !today.alcohol,
          failed: today.alcohol,
          type: 'negative'
        }
      ];
      
      const checklistHTML = checklistItems.map(item => `
        <div class="checklist-item ${item.completed ? 'completed' : ''} ${item.failed ? 'failed' : ''}" 
             onclick="toggleChecklist('${item.id}')">
          <div class="checklist-checkbox">
            ${item.completed ? '‚úì' : (item.failed ? '‚úó' : '')}
          </div>
          <div class="checklist-content">
            <div class="checklist-title">${item.title}</div>
            <div class="checklist-desc">${item.desc}</div>
          </div>
        </div>
      `).join('');
      
      // Completed count for today
      const completedCount = checklistItems.filter(i => i.completed && !i.failed).length;
      const totalChecklist = checklistItems.length;
      
      document.getElementById('app').innerHTML = `
        <!-- Hero Status -->
        <div class="hero ${today.workout_done ? 'success' : 'danger'}">
          <div class="hero-icon">${today.workout_done ? 'üí™' : 'üò§'}</div>
          <div class="hero-title">${today.workout_done ? 'WORKOUT FATTO!' : 'NESSUN WORKOUT OGGI'}</div>
          <div class="hero-subtitle">
            ${today.workout_done 
              ? `${today.workout?.type || 'Attivit√†'} registrata ‚Ä¢ ${today.workout?.strain?.toFixed(1) || '-'} strain`
              : `${today.reminders_sent} reminder inviati oggi`}
          </div>
        </div>
        
        <!-- Whoop Data -->
        ${data.user.whoop_connected ? `
          <div class="whoop-section">
            <div class="section-title">üìä Dati Whoop Oggi</div>
            <div class="whoop-grid">
              <div class="whoop-metric">
                <div class="whoop-metric-value ${today.recovery ? getRecoveryColor(today.recovery.score) : ''}">${today.recovery?.score || '-'}%</div>
                <div class="whoop-metric-label">Recovery</div>
                ${today.recovery?.hrv ? `<div class="whoop-metric-detail">HRV: ${today.recovery.hrv.toFixed(0)} ms</div>` : ''}
              </div>
              
              <div class="whoop-metric">
                <div class="whoop-metric-value">${today.strain?.toFixed(1) || '-'}</div>
                <div class="whoop-metric-label">Strain</div>
                <div class="whoop-metric-detail">/ 21</div>
              </div>
              
              <div class="whoop-metric">
                <div class="whoop-metric-value">${today.sleep?.performance?.toFixed(0) || '-'}%</div>
                <div class="whoop-metric-label">Sleep</div>
                ${today.sleep?.duration_hours ? `<div class="whoop-metric-detail">${today.sleep.duration_hours}h</div>` : ''}
              </div>
              
              <div class="whoop-metric">
                <div class="whoop-metric-value">${today.recovery?.resting_hr?.toFixed(0) || '-'}</div>
                <div class="whoop-metric-label">RHR</div>
                <div class="whoop-metric-detail">bpm</div>
              </div>
              
              ${today.workout ? `
                <div class="whoop-metric">
                  <div class="whoop-metric-value" style="color: var(--success);">${today.workout.calories || '-'}</div>
                  <div class="whoop-metric-label">Calorie</div>
                  <div class="whoop-metric-detail">${today.workout.type || 'Workout'}</div>
                </div>
                
                <div class="whoop-metric">
                  <div class="whoop-metric-value" style="color: var(--success);">${today.workout.strain?.toFixed(1) || '-'}</div>
                  <div class="whoop-metric-label">Workout Strain</div>
                  <div class="whoop-metric-detail">${today.workout.duration_minutes || '-'} min</div>
                </div>
              ` : ''}
            </div>
          </div>
        ` : `
          <div class="connect-section">
            <div class="section-title">üì± Connetti Whoop</div>
            <p>Connetti il tuo Whoop per tracciare automaticamente workout, Recovery, Strain e Sleep</p>
            <a href="/auth/whoop">Connetti Whoop ‚Üí</a>
          </div>
        `}
        
        <!-- Daily Checklist -->
        <div class="checklist-section">
          <div class="section-title">‚úÖ Checklist Oggi (${completedCount}/${totalChecklist})</div>
          ${checklistHTML}
        </div>
        
        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">üî• Streak</div>
            <div class="stat-value ${stats.current_streak > 0 ? 'success' : 'danger'}">${stats.current_streak}</div>
            <div class="stat-detail">giorni consecutivi</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-label">‚öñÔ∏è Peso</div>
            <div class="stat-value">${weight.current}</div>
            <div class="stat-detail">${weight.lost >= 0 ? '-' : '+'}${Math.abs(weight.lost).toFixed(1)} kg</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-label">üéØ Mancano</div>
            <div class="stat-value warning">${weight.to_go.toFixed(1)}</div>
            <div class="stat-detail">kg a 85 kg</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-label">üí™ Workout</div>
            <div class="stat-value">${stats.total_workouts}</div>
            <div class="stat-detail">totali</div>
          </div>
        </div>
        
        <!-- Weight Progress -->
        <div class="weight-section">
          <div class="section-title">‚öñÔ∏è Progresso Peso</div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${progressPercent}%"></div>
          </div>
          <div class="progress-labels">
            <span>93 kg</span>
            <span>${progressPercent.toFixed(0)}%</span>
            <span>85 kg üéØ</span>
          </div>
          
          <div class="weight-input-row">
            <input type="number" id="weight-input" placeholder="Peso" step="0.1" min="60" max="150" value="${weight.current}">
            <button onclick="logWeight()">Salva</button>
          </div>
        </div>
        
        <!-- Activity History -->
        <div class="activity-section">
          <div class="section-title">üìÖ Ultimi 7 Giorni</div>
          ${activityRows || '<p style="color: var(--muted)">Nessuna attivit√† registrata</p>'}
          
          <div class="action-buttons">
            <button class="secondary" onclick="syncWhoop()">üîÑ Sync Whoop</button>
            <button class="secondary" onclick="forceCheck()">‚ö° Forza Check</button>
          </div>
        </div>
      `;
    }
    
    // Toggle checklist items
    async function toggleChecklist(id) {
      const data = {};
      
      switch(id) {
        case 'workout':
          data.workout_done = !dashboardData.today.workout_done;
          break;
        case 'meals':
          data.meals_ok = !dashboardData.today.meals_ok;
          break;
        case 'alcohol':
          data.alcohol = !dashboardData.today.alcohol;
          break;
      }
      
      await updateActivity(data);
    }
    
    // Actions
    async function logWeight() {
      const input = document.getElementById('weight-input');
      const weight = parseFloat(input.value);
      if (!weight || weight < 60 || weight > 150) {
        alert('Inserisci un peso valido (60-150 kg)');
        return;
      }
      
      try {
        await fetch(`${API_BASE}/weight`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ weight })
        });
        await fetchDashboard();
      } catch (error) {
        alert('Errore: ' + error.message);
      }
    }
    
    async function updateActivity(data) {
      try {
        await fetch(`${API_BASE}/activity`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        await fetchDashboard();
      } catch (error) {
        alert('Errore: ' + error.message);
      }
    }
    
    async function syncWhoop() {
      try {
        const res = await fetch(`${API_BASE}/sync-whoop`, { method: 'POST' });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        await fetchDashboard();
        alert('Sync completato!');
      } catch (error) {
        alert('Errore sync: ' + error.message);
      }
    }
    
    async function forceCheck() {
      try {
        await fetch(`${API_BASE}/force-check`, { method: 'POST' });
        alert('Check eseguito!');
        await fetchDashboard();
      } catch (error) {
        alert('Errore: ' + error.message);
      }
    }
    
    // Init
    fetchDashboard();
    
    // Auto-refresh ogni 2 minuti
    setInterval(fetchDashboard, 2 * 60 * 1000);
    
    // Check URL params
    const params = new URLSearchParams(window.location.search);
    if (params.get('success') === 'whoop_connected') {
      alert('‚úÖ Whoop connesso con successo!');
      window.history.replaceState({}, '', '/');
    }
    if (params.get('error')) {
      alert('‚ùå Errore: ' + params.get('error'));
      window.history.replaceState({}, '', '/');
    }
  </script>
</body>
</html>
