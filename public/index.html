<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üèÉ MUOVITI - Whoop Nagger</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Space+Grotesk:wght@400;700&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --bg: #0a0a0a;
      --card: #141414;
      --border: #2a2a2a;
      --text: #e0e0e0;
      --muted: #666;
      --success: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
      --accent: #3b82f6;
    }
    
    body {
      font-family: 'Space Grotesk', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    h1 {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 800;
      font-size: 1.5rem;
      letter-spacing: -1px;
    }
    
    .status-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--card);
      border-radius: 20px;
      font-size: 0.85rem;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }
    
    .status-dot.disconnected {
      background: var(--danger);
    }
    
    /* Hero Status */
    .hero {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
    }
    
    .hero.success {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, var(--card) 100%);
    }
    
    .hero.danger {
      border-color: var(--danger);
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, var(--card) 100%);
      animation: pulse-danger 2s ease-in-out infinite;
    }
    
    @keyframes pulse-danger {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
    }
    
    .hero-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }
    
    .hero-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 10px;
    }
    
    .hero.danger .hero-title {
      color: var(--danger);
    }
    
    .hero.success .hero-title {
      color: var(--success);
    }
    
    .hero-subtitle {
      color: var(--muted);
      font-size: 1.1rem;
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
    }
    
    .stat-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 2rem;
      font-weight: 700;
    }
    
    .stat-value.success { color: var(--success); }
    .stat-value.danger { color: var(--danger); }
    .stat-value.warning { color: var(--warning); }
    
    .stat-detail {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 4px;
    }
    
    /* Weight Section */
    .weight-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 30px;
    }
    
    .section-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1rem;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .progress-bar {
      height: 24px;
      background: var(--border);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      margin-bottom: 15px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), var(--accent));
      border-radius: 12px;
      transition: width 0.5s ease;
    }
    
    .progress-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: var(--muted);
    }
    
    .weight-input-row {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    input[type="number"] {
      flex: 1;
      padding: 12px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 1rem;
    }
    
    input[type="number"]:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    button {
      padding: 12px 24px;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: white;
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.1s, opacity 0.2s;
    }
    
    button:hover {
      opacity: 0.9;
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    button.secondary {
      background: var(--border);
    }
    
    button.danger {
      background: var(--danger);
    }
    
    /* Activity Log */
    .activity-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 30px;
    }
    
    .day-row {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .day-row:last-child {
      border-bottom: none;
    }
    
    .day-date {
      width: 100px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      color: var(--muted);
    }
    
    .day-status {
      width: 30px;
      text-align: center;
    }
    
    .day-details {
      flex: 1;
      font-size: 0.9rem;
      color: var(--muted);
    }
    
    /* Whoop Connection */
    .connect-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      margin-bottom: 30px;
    }
    
    .connect-section a {
      display: inline-block;
      padding: 12px 24px;
      background: #ff6b00;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 700;
      margin-top: 15px;
    }
    
    /* Manual Log */
    .manual-log {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    
    .toggle-btn {
      padding: 10px 20px;
      background: var(--border);
      border: 2px solid transparent;
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .toggle-btn.active {
      border-color: var(--success);
      background: rgba(34, 197, 94, 0.2);
    }
    
    .toggle-btn.active.danger-toggle {
      border-color: var(--danger);
      background: rgba(239, 68, 68, 0.2);
    }
    
    /* Footer */
    footer {
      text-align: center;
      padding: 20px;
      color: var(--muted);
      font-size: 0.85rem;
    }
    
    /* Responsive */
    @media (max-width: 600px) {
      .hero {
        padding: 30px 20px;
      }
      
      .hero-title {
        font-size: 1.5rem;
      }
      
      .stat-value {
        font-size: 1.5rem;
      }
      
      header {
        flex-direction: column;
        gap: 15px;
      }
    }
    
    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      color: var(--muted);
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üèÉ WHOOP NAGGER</h1>
      <div class="status-badge" id="whoop-status">
        <span class="status-dot disconnected"></span>
        <span>Caricamento...</span>
      </div>
    </header>
    
    <main id="app">
      <div class="loading">
        <div class="spinner"></div>
      </div>
    </main>
    
    <footer>
      Obiettivo Pasqua: 85 kg ‚Ä¢ Un giorno alla volta üí™
    </footer>
  </div>
  
  <script>
    const API_BASE = '/api';
    let dashboardData = null;
    
    // Fetch dashboard data
    async function fetchDashboard() {
      try {
        const res = await fetch(`${API_BASE}/dashboard`);
        const data = await res.json();
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        dashboardData = data;
        render();
      } catch (error) {
        console.error('Error fetching dashboard:', error);
        document.getElementById('app').innerHTML = `
          <div class="hero danger">
            <div class="hero-icon">‚ùå</div>
            <div class="hero-title">ERRORE</div>
            <div class="hero-subtitle">${error.message}</div>
            <p style="margin-top: 20px; color: var(--muted);">
              Controlla che:<br>
              - Il database Supabase sia configurato<br>
              - L'utente esista nella tabella users<br>
              - Le variabili .env siano corrette
            </p>
          </div>
        `;
      }
    }
    
    // Render dashboard
    function render() {
      const data = dashboardData;
      const today = data.today;
      const stats = data.stats;
      const weight = data.weight;
      
      // Update Whoop status
      const statusEl = document.getElementById('whoop-status');
      if (data.user.whoop_connected) {
        statusEl.innerHTML = `
          <span class="status-dot"></span>
          <span>Whoop connesso</span>
        `;
      } else {
        statusEl.innerHTML = `
          <span class="status-dot disconnected"></span>
          <span>Whoop non connesso</span>
        `;
      }
      
      // Calculate progress
      const totalToLose = 93 - 85; // 8 kg
      const lost = 93 - weight.current;
      const progressPercent = Math.min(100, Math.max(0, (lost / totalToLose) * 100));
      
      // Format activity history
      const activityRows = data.activity_history.slice(0, 7).map(day => {
        const date = new Date(day.date);
        const dateStr = date.toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric' });
        const icon = day.workout_done ? '‚úÖ' : '‚ùå';
        let detail = '';
        if (day.workout_type) detail += day.workout_type;
        if (day.workout_strain) detail += ` ‚Ä¢ Strain: ${day.workout_strain.toFixed(1)}`;
        if (day.alcohol) detail += ' ‚Ä¢ üç∫';
        
        return `
          <div class="day-row">
            <div class="day-date">${dateStr}</div>
            <div class="day-status">${icon}</div>
            <div class="day-details">${detail || '-'}</div>
          </div>
        `;
      }).join('');
      
      document.getElementById('app').innerHTML = `
        <!-- Hero Status -->
        <div class="hero ${today.workout_done ? 'success' : 'danger'}">
          <div class="hero-icon">${today.workout_done ? 'üí™' : 'üò§'}</div>
          <div class="hero-title">${today.workout_done ? 'WORKOUT FATTO!' : 'NESSUN WORKOUT OGGI'}</div>
          <div class="hero-subtitle">
            ${today.workout_done 
              ? `${today.workout?.type || 'Attivit√†'} registrata ‚Ä¢ ${today.workout?.strain?.toFixed(1) || '-'} strain`
              : `${today.reminders_sent} reminder inviati oggi`}
          </div>
          ${today.recovery ? `<div class="hero-subtitle" style="margin-top: 10px;">Recovery: ${today.recovery.score}% ‚Ä¢ HRV: ${today.recovery.hrv?.toFixed(0)} ms</div>` : ''}
        </div>
        
        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Streak Attuale</div>
            <div class="stat-value ${stats.current_streak > 0 ? 'success' : 'danger'}">${stats.current_streak}</div>
            <div class="stat-detail">giorni consecutivi</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-label">Peso Attuale</div>
            <div class="stat-value">${weight.current}</div>
            <div class="stat-detail">kg ‚Ä¢ ${weight.lost >= 0 ? '-' : '+'}${Math.abs(weight.lost).toFixed(1)} kg dal 3 gen</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-label">Mancano</div>
            <div class="stat-value warning">${weight.to_go.toFixed(1)}</div>
            <div class="stat-detail">kg all'obiettivo (85 kg)</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-label">Workout Totali</div>
            <div class="stat-value">${stats.total_workouts}</div>
            <div class="stat-detail">dal 3 gennaio</div>
          </div>
        </div>
        
        <!-- Weight Progress -->
        <div class="weight-section">
          <div class="section-title">‚öñÔ∏è Progresso Peso</div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${progressPercent}%"></div>
          </div>
          <div class="progress-labels">
            <span>93 kg (inizio)</span>
            <span>${progressPercent.toFixed(0)}% completato</span>
            <span>85 kg (obiettivo)</span>
          </div>
          
          <div class="weight-input-row">
            <input type="number" id="weight-input" placeholder="Inserisci peso" step="0.1" min="60" max="150" value="${weight.current}">
            <button onclick="logWeight()">Salva Peso</button>
          </div>
        </div>
        
        <!-- Whoop Connection -->
        ${!data.user.whoop_connected ? `
          <div class="connect-section">
            <div class="section-title">üì± Connetti Whoop</div>
            <p>Connetti il tuo Whoop per tracciare automaticamente i workout</p>
            <a href="/auth/whoop">Connetti Whoop ‚Üí</a>
          </div>
        ` : ''}
        
        <!-- Manual Log -->
        <div class="activity-section">
          <div class="section-title">üìù Log Manuale Oggi</div>
          <div class="manual-log">
            <button class="toggle-btn ${today.workout_done ? 'active' : ''}" onclick="toggleWorkout()">
              ${today.workout_done ? '‚úÖ' : '‚¨ú'} Workout Fatto
            </button>
            <button class="toggle-btn ${today.meals_ok ? 'active' : ''}" onclick="toggleMeals()">
              ${today.meals_ok ? '‚úÖ' : '‚¨ú'} Pasti OK
            </button>
            <button class="toggle-btn danger-toggle ${today.alcohol ? 'active' : ''}" onclick="toggleAlcohol()">
              ${today.alcohol ? 'üç∫' : '‚¨ú'} Alcol
            </button>
          </div>
          <div style="margin-top: 15px;">
            <button class="secondary" onclick="syncWhoop()">üîÑ Sync Whoop</button>
            <button class="secondary" onclick="forceCheck()">‚ö° Forza Check</button>
          </div>
        </div>
        
        <!-- Activity History -->
        <div class="activity-section">
          <div class="section-title">üìÖ Ultimi 7 Giorni</div>
          ${activityRows || '<p style="color: var(--muted)">Nessuna attivit√† registrata</p>'}
        </div>
      `;
    }
    
    // Actions
    async function logWeight() {
      const input = document.getElementById('weight-input');
      const weight = parseFloat(input.value);
      if (!weight || weight < 60 || weight > 150) {
        alert('Inserisci un peso valido (60-150 kg)');
        return;
      }
      
      try {
        await fetch(`${API_BASE}/weight`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ weight })
        });
        await fetchDashboard();
      } catch (error) {
        alert('Errore: ' + error.message);
      }
    }
    
    async function toggleWorkout() {
      const newValue = !dashboardData.today.workout_done;
      await updateActivity({ workout_done: newValue });
    }
    
    async function toggleMeals() {
      const newValue = !dashboardData.today.meals_ok;
      await updateActivity({ meals_ok: newValue });
    }
    
    async function toggleAlcohol() {
      const newValue = !dashboardData.today.alcohol;
      await updateActivity({ alcohol: newValue });
    }
    
    async function updateActivity(data) {
      try {
        await fetch(`${API_BASE}/activity`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        await fetchDashboard();
      } catch (error) {
        alert('Errore: ' + error.message);
      }
    }
    
    async function syncWhoop() {
      try {
        const res = await fetch(`${API_BASE}/sync-whoop`, { method: 'POST' });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        await fetchDashboard();
        alert('Sync completato!');
      } catch (error) {
        alert('Errore sync: ' + error.message);
      }
    }
    
    async function forceCheck() {
      try {
        await fetch(`${API_BASE}/force-check`, { method: 'POST' });
        alert('Check eseguito! Controlla la console del server.');
      } catch (error) {
        alert('Errore: ' + error.message);
      }
    }
    
    // Init
    fetchDashboard();
    
    // Auto-refresh ogni 5 minuti
    setInterval(fetchDashboard, 5 * 60 * 1000);
    
    // Check URL params
    const params = new URLSearchParams(window.location.search);
    if (params.get('success') === 'whoop_connected') {
      alert('‚úÖ Whoop connesso con successo!');
      window.history.replaceState({}, '', '/');
    }
    if (params.get('error')) {
      alert('‚ùå Errore: ' + params.get('error'));
      window.history.replaceState({}, '', '/');
    }
  </script>
</body>
</html>
